<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="|Chi ti·∫øt Sinh vi√™n: ${student.studentName}|"></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
<style>
  #chatToggleButton {
    position: fixed;
    bottom: 25px;
    right: 25px;
    width: 60px;
    height: 60px;
    z-index: 1050;
    font-size: 1.5rem;
  }

  #chatWindow {
    position: fixed;
    bottom: 100px;
    right: 25px;
    width: 380px;
    max-width: 90vw;
    height: 500px;
    max-height: 70vh;
    z-index: 1049;
    display: none; /* ·∫®n ban ƒë·∫ßu */
    flex-direction: column;
    border-radius: 15px;
    overflow: hidden;
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    transform: translateY(20px);
    opacity: 0;
  }

  #chatWindow.show {
    display: flex;
    transform: translateY(0);
    opacity: 1;
  }

  #chatMessages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .chat-message {
    display: flex;
    max-width: 85%;
  }

  .chat-message .message-content {
    padding: 10px 15px;
    border-radius: 20px;
    word-wrap: break-word;
  }

  /* Tin nh·∫Øn c·ªßa AI */
  .ai-message {
    align-self: flex-start;
  }
  .ai-message .message-content {
    background-color: #e9ecef;
    color: #212529;
    border-top-left-radius: 5px;
  }
  /* Tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng */
  .user-message {
    align-self: flex-end;
  }
  .user-message .message-content {
    background-color: #0d6efd;
    color: white;
    border-top-right-radius: 5px;
  }
  /* Ch·ªâ b√°o AI ƒëang g√µ */
  .typing-indicator {
    align-self: flex-start;
    font-style: italic;
    color: #6c757d;
  }
</style>
<div class="container mt-4">
  <h1 class="mb-4 text-success">Chi ti·∫øt Sinh vi√™n: <span th:text="${student.studentName}"></span></h1>
  <input type="hidden" id="studentId" th:value="${student.studentId}" />
  <div th:if="${message}" class="alert alert-success" role="alert">
    <span th:text="${message}">Thao t√°c th√†nh c√¥ng!</span>
  </div>
  <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
    <span th:text="${errorMessage}">Thao t√°c th·∫•t b·∫°i!</span>
  </div>

  <div th:if="${summary.hasScores}">
    <h2 class="mt-4 text-primary">Dashboard H·ªçc l·ª±c</h2>

    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5>T·ªïng quan ƒê√°nh gi√° H·ªçc t·∫≠p</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">

          <div class="col-md-4 mb-3">
            <div class="h5 text-secondary">ƒêi·ªÉm Trung b√¨nh (GPA)</div>
            <div class="display-4 text-primary" th:text="${summary.gpa}">N/A</div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="h5 text-secondary">Tr·∫°ng th√°i Hi·ªán t·∫°i</div>
            <div th:classappend="${summary.status == 'Xu·∫•t s·∫Øc' ? 'text-success' :
                                  (summary.status == 'Gi·ªèi' ? 'text-info' :
                                  (summary.status == 'Kh√°' ? 'text-warning' :
                                  (summary.status == 'Trung b√¨nh' ? 'text-secondary' : 'text-danger')))}"
                 th:text="${summary.status}" class="display-4">N/A</div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="h5 text-secondary">T·ªïng s·ªë m√¥n ƒë√£ ch·∫•m</div>
            <div class="display-4 text-info" th:text="${summary.totalSubjects}">0</div>
          </div>
        </div>
      </div>
    </div>

    <div th:classappend="${summary.status == 'K√©m' || summary.status == 'Y·∫øu' ? 'alert-danger' : 'alert-info'}" class="alert shadow-sm" role="alert">
      <h5 th:text="${summary.status == 'K√©m' || summary.status == 'Y·∫øu' ? 'üö® C·∫¢NH B√ÅO H·ªåC T·∫¨P' : 'üí° L·ªúI KHUY√äN C√Å NH√ÇN'}" class="alert-heading">L·ªùi khuy√™n</h5>
      <p th:text="${summary.reminder}">Kh√¥ng c√≥ l·ªùi nh·∫Øc nh·ªü c·ª• th·ªÉ.</p>
    </div>

    <hr class="my-5"/>
  </div>
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h5>Th√¥ng tin c√° nh√¢n</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>ID:</strong> <span th:text="${student.studentId}">1</span></p>
          <p><strong>T√™n Sinh vi√™n:</strong> <span th:text="${student.studentName}"></span></p>
          <p><strong>Email:</strong> <span th:text="${student.email}">a@gmail.com</span></p>
        </div>
        <div class="col-md-6">
          <p><strong>SƒêT:</strong> <span th:text="${student.sdt}">0912345678</span></p>
          <p><strong>Chuy√™n ng√†nh:</strong> <span th:text="${student.chuyenNganh}">N/A</span></p>
          <p><strong>ID L·ªõp h·ªçc (Kh√≥a ngo·∫°i):</strong> <span th:text="${student.idClass}">1</span></p>
        </div>
      </div>

      <div class="mt-3">
        <a th:href="@{/students/edit/{id}(id=${student.studentId})}" class="btn btn-sm btn-primary">
          ‚úèÔ∏è S·ª≠a th√¥ng tin Sinh vi√™n
        </a>
      </div>
    </div>
  </div>

  <h2 class="mt-4 text-info">Th√¥ng tin L·ªõp h·ªçc</h2>
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div th:if="${student.classInfo != null}" th:object="${student.classInfo}">
        <div class="row">
          <div class="col-md-6">
            <p><strong>ID L·ªõp:</strong> <span th:text="*{idClass}">1</span></p>
            <p><strong>T√™n L·ªõp:</strong> <span th:text="*{className}">CNTT1</span></p>
            <p><strong>Kh√≥a h·ªçc:</strong> <span th:text="*{khoaHoc}">Khoa CNTT</span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Tr·∫°ng th√°i l·ªõp:</strong> <span th:text="*{trangThai}">ƒêang ho·∫°t ƒë·ªông</span></p>
            <p><strong>Ch·ªâ ti√™u SV:</strong> <span th:text="*{soLuongSinhVien}">20</span></p>
          </div>
        </div>
        <div class="mt-3">
          <a th:href="@{/classes/edit/{id}(id=*{idClass})}" class="btn btn-sm btn-info">
            ‚úèÔ∏è S·ª≠a L·ªõp h·ªçc n√†y
          </a>
        </div>
      </div>

      <p th:unless="${student.classInfo != null}" class="alert alert-warning text-dark">
        <i class="fas fa-exclamation-triangle"></i> H·ªá th·ªëng ƒëang s·∫Øp x·∫øp l·ªõp h·ªçc cho b·∫°n (Sinh vi√™n ch∆∞a ƒë∆∞·ª£c ph√¢n l·ªõp).
      </p>
    </div>
  </div>

  <h2 class="mt-4 text-warning">Danh s√°ch ƒêi·ªÉm</h2>
  <table class="table table-bordered table-hover">
    <thead class="table-warning">
    <tr>
      <th>ID ƒêi·ªÉm</th>
      <th>M√¥n h·ªçc</th>
      <th>ƒêi·ªÉm s·ªë</th>
      <th>ID Sinh vi√™n</th>
      <th>Ng√†y c·∫≠p nh·∫≠t</th>
      <th>H√†nh ƒë·ªông</th> </tr>
    </thead>
    <tbody>
    <tr th:each="diem : ${student.scores}">
      <td th:text="${diem.diemid}">1</td>
      <td th:text="${diem.monhoc}">CNTT</td>
      <td th:text="${diem.diem}">10.0</td>
      <td th:text="${diem.id}">1</td>
      <td th:text="${#dates.format(diem.ngayCapNhat, 'dd-MM-yyyy HH:mm')}">30-09-2025 10:30</td>

      <td>
        <a th:href="@{/diems/edit/{id}(id=${diem.diemid})}" class="btn btn-sm btn-warning">
          S·ª≠a ƒêi·ªÉm
        </a>
        <a th:href="@{/diems/delete/{diemId}(diemId=${diem.diemid})}"
           class="btn btn-sm btn-danger"
           onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒëi·ªÉm s·ªë n√†y kh√¥ng?');">
          X√≥a
        </a>
      </td>
    </tr>

    <tr th:if="${#lists.isEmpty(student.scores)}">
      <td colspan="6" class="text-center text-muted">Sinh vi√™n n√†y ch∆∞a c√≥ ƒëi·ªÉm n√†o.</td>
    </tr>
    </tbody>
  </table>

  <a th:href="@{/students/list}" class="btn btn-secondary mt-3">Quay l·∫°i danh s√°ch</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const chatToggleButton = document.getElementById('chatToggleButton');
    const chatWindow = document.getElementById('chatWindow');
    const closeChatButton = document.getElementById('closeChatButton');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');

    chatToggleButton.addEventListener('click', () => chatWindow.classList.toggle('show'));
    closeChatButton.addEventListener('click', () => chatWindow.classList.remove('show'));

    chatForm.addEventListener('submit', async function (event) {
      event.preventDefault();
      const userMessage = chatInput.value.trim();
      const studentId = document.getElementById('studentId').value;

      if (userMessage === '') return;

      appendMessage(userMessage, 'user');
      chatInput.value = '';
      const typingIndicator = showTypingIndicator();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage, studentId: studentId })
        });

        if (!response.ok) { throw new Error('Network response was not ok.'); }

        const data = await response.json();
        typingIndicator.remove();
        appendMessage(data.reply, 'ai');

      } catch (error) {
        console.error('Error fetching chat response:', error);
        typingIndicator.remove();
        appendMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.', 'ai');
      }
    });

    function appendMessage(message, sender) {
      const messageWrapper = document.createElement('div');
      messageWrapper.classList.add('chat-message', sender + '-message');
      const messageContent = document.createElement('div');
      messageContent.classList.add('message-content');
      messageContent.textContent = message;
      messageWrapper.appendChild(messageContent);
      chatMessages.appendChild(messageWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
      const indicator = document.createElement('div');
      indicator.classList.add('chat-message', 'ai-message', 'typing-indicator');
      const content = document.createElement('div');
      content.classList.add('message-content');
      content.innerHTML = '<i>Tr·ª£ l√Ω ƒëang so·∫°n c√¢u tr·∫£ l·ªùi...</i>';
      indicator.appendChild(content);
      chatMessages.appendChild(indicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return indicator;
    }
  });
</script>

<button class="btn btn-primary rounded-circle shadow-lg" id="chatToggleButton" title="Tr·ª£ l√Ω AI">
  <i class="fas fa-comment-dots fa-lg"></i>
</button>

<div class="card shadow-lg" id="chatWindow">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Tr·ª£ l√Ω AI Gi√°o d·ª•c</h5>
    <button type="button" class="btn-close btn-close-white" id="closeChatButton" aria-label="Close"></button>
  </div>
  <div class="card-body" id="chatMessages">
    <div class="chat-message ai-message">
      <div class="message-content">
        Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n v·ªÅ v·∫•n ƒë·ªÅ h·ªçc t·∫≠p?
      </div>
    </div>
  </div>
  <div class="card-footer">
    <form id="chatForm">
      <div class="input-group">
        <input type="text" id="chatInput" class="form-control" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." autocomplete="off">
        <button class="btn btn-primary" type="submit" id="sendChatButton">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </form>
  </div>
</div>
</body>

</html>