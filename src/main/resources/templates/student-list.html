<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{page.title.studentList}">Dashboard - Quản lý Sinh viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa; /* Nền xám nhạt cho toàn trang */
        }
        .card {
            border: none; /* Bỏ viền mặc định của card */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef; /* Màu nền khi hover vào dòng của bảng */
            cursor: pointer;
        }
        .badge-arranging {
            background-color: #ffc107;
            color: #212529;
        }
        .carousel-control-prev-icon, .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 1.5rem;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .action-buttons a {
            margin: 0 4px;
        }
    </style>
</head>
<body>
<div class="container mt-4 mb-5">

    <!-- HEADER CARD -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-4 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0 text-primary" th:text="#{header.studentList}">Student Management Dashboard</h1>
                <p class="text-muted mb-0" th:text="#{header.studentList.subtitle}">Tổng quan và quản lý sinh viên</p>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" th:title="#{lang.switch.tooltip}">
                    <i class="fas fa-globe"></i> <span th:text="#{general.language?:'Ngôn ngữ'}"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" th:href="@{/students/list(lang='vi')}" th:text="#{lang.vietnamese}"></a></li>
                    <li><a class="dropdown-item" th:href="@{/students/list(lang='en')}" th:text="#{lang.english}"></a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ALERT MESSAGES -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <i class="fas fa-check-circle me-2"></i> <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i> <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- MAIN ACTIONS CARD -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2">
                <a th:href="@{/students/add}" class="btn btn-success"><i class="fas fa-user-plus me-2"></i><span th:text="#{student.button.add}"></span></a>
                <a th:href="@{/classes/add}" class="btn btn-info"><i class="fas fa-school me-2"></i><span th:text="#{button.addClass}"></span></a>
                <a th:href="@{/diems/add}" class="btn btn-warning"><i class="fas fa-graduation-cap me-2"></i><span th:text="#{button.addScore}"></span></a>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importExcelModal">
                    <i class="fas fa-file-import me-2"></i><span th:text="#{button.importExcel}"></span>
                </button>
                <a th:href="@{/students/export-excel}" class="btn btn-dark ms-auto">
                    <i class="fas fa-file-excel me-2"></i><span th:text="#{button.exportExcel}"></span>
                </a>
            </div>
        </div>
    </div>

    <!-- CHARTS CARD -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0 text-primary"><i class="fas fa-chart-pie me-2"></i><span th:text="#{header.chart}"></span></h4>
        </div>
        <div class="card-body">
            <div id="chartCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="text-center bg-primary-subtle text-primary-emphasis p-2 mb-3 rounded">
                            <h5 class="mb-0" th:text="#{chart.cardHeader}"></h5>
                        </div>
                        <p class="text-center text-muted"><span th:text="#{chart.totalStudentsLabel}"></span>: <strong th:text="${academicChartData?.get('totalStudentsChecked') ?: 0}"></strong></p>
                        <canvas id="academicPieChart" style="max-height: 350px;"></canvas>
                        <p th:if="${academicChartData == null or academicChartData.get('totalStudentsChecked') == 0}" class="text-center text-danger mt-3" th:text="#{chart.noData}"></p>
                    </div>
                    <div class="carousel-item">
                        <div class="text-center bg-secondary-subtle text-secondary-emphasis p-2 mb-3 rounded">
                            <h5 class="mb-0">Phân bổ Sinh viên theo Chuyên ngành</h5>
                        </div>
                        <p class="text-center text-muted"><span th:text="|#{chart.totalStudentsLabel} (Tổng SV):|"></span>: <strong th:text="${majorChartData?.get('totalStudents') ?: 0}"></strong></p>
                        <canvas id="majorBarChart" style="max-height: 350px;"></canvas>
                        <p th:if="${majorChartData == null or majorChartData.get('totalStudents') == 0}" class="text-center text-danger mt-3"></p>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#chartCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span></button>
                <button class="carousel-control-next" type="button" data-bs-target="#chartCarousel" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span></button>
            </div>
        </div>
    </div>

    <!-- STUDENT LIST TABLE CARD -->
    <div class="card shadow-sm">
        <div class="card-header bg-light p-3">
            <h4 class="mb-0 text-primary"><i class="fas fa-list-ul me-2"></i><span th:text="#{table.title.detailedList}"></span></h4>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th th:text="#{table.header.id}"></th>
                        <th th:text="#{table.header.studentName}"></th>
                        <th th:text="#{table.header.email}"></th>
                        <th th:text="#{table.header.major}"></th>
                        <th th:text="#{table.header.class}"></th>
                        <th th:text="#{table.header.enrollment}"></th>
                        <th class="text-center" th:text="#{table.header.totalScores}"></th>
                        <th class="text-center" th:text="#{table.header.actions}"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="student : ${students}">
                        <td th:text="${student.studentId}"></td>
                        <td>
                            <div class="fw-bold" th:text="${student.studentName}"></div>
                            <div class="small text-muted" th:text="${student.sdt}"></div>
                        </td>
                        <td th:text="${student.email}"></td>
                        <td th:text="${student.chuyenNganh}"></td>

                        <td colspan="2" th:if="${student.classInfo == null}">
                            <span class="badge badge-arranging text-dark p-2" th:text="#{status.arrangingClass}"></span>
                        </td>

                        <td th:unless="${student.classInfo == null}">
                            <span class="fw-bold" th:text="${student.classInfo.className}"></span>
                            <div class="small text-muted" th:text="${student.classInfo.khoaHoc}"></div>
                        </td>
                        <td th:unless="${student.classInfo == null}" th:text="|${student.classInfo.soLuongSinhVienHienTai} / ${student.classInfo.soLuongSinhVien}|"></td>

                        <td class="text-center"><span class="badge bg-primary rounded-pill" th:text="${student.scores != null ? student.scores.size() : 0}"></span></td>

                        <td class="text-center action-buttons">
                            <a th:href="@{/students/detail/{id}(id=${student.studentId})}" class="btn btn-sm btn-outline-primary" th:title="#{button.viewDetails}"><i class="fas fa-eye"></i></a>
                            <a th:href="@{/students/delete/{id}(id=${student.studentId})}" class="btn btn-sm btn-outline-danger" th:onclick="|return confirm('[[#{confirm.deleteStudent}]]');|" th:title="#{button.delete}"><i class="fas fa-trash-alt"></i></a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL IMPORT EXCEL -->
<div class="modal fade" id="importExcelModal" tabindex="-1" aria-labelledby="importExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importExcelModalLabel"><i class="fas fa-file-excel text-success me-2"></i> Nhập Sinh viên từ File Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/students/upload-excel}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-3">
                        <label for="file" class="form-label">Chọn file Excel:</label>
                        <input type="file" class="form-control" name="file" id="file" accept=".xlsx, .xls" required>
                    </div>
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Định dạng file yêu cầu:</h6>
                        <ul class="mb-0 small">
                            <li>File phải là `.xlsx` hoặc `.xls`.</li>
                            <li>Dòng đầu tiên là tiêu đề (sẽ được bỏ qua).</li>
                            <li>Dữ liệu sinh viên bắt đầu từ dòng thứ 2.</li>
                            <li>Thứ tự các cột: <strong>Tên SV, Email, SĐT, Chuyên ngành</strong>.</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="submit" class="btn btn-success" form="uploadForm"><i class="fas fa-upload me-2"></i> Tải lên</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // JAVASCRIPT FOR CHARTS
    const academicChartData = /*[[${academicChartData}]]*/ null;
    const majorChartData = /*[[${majorChartData}]]*/ null;
    const chartMessages = { label: /*[[#{chart.tooltip.label}]]*/ 'Số lượng Sinh viên', studentUnit: /*[[#{chart.tooltip.studentUnit}]]*/ 'SV' };
    const rankingLabels = { "Xuất sắc": /*[[#{ranking.excellent}]]*/ 'Xuất sắc', "Giỏi": /*[[#{ranking.good}]]*/ 'Giỏi', "Khá": /*[[#{ranking.fair}]]*/ 'Khá', "Trung bình": /*[[#{ranking.average}]]*/ 'Trung bình', "Yếu": /*[[#{ranking.weak}]]*/ 'Yếu', "Kém": /*[[#{ranking.poor}]]*/ 'Kém' };

    function drawAcademicChart() {
        if (!academicChartData || !academicChartData.counts || Object.keys(academicChartData.counts).length === 0) return;
        const chartCounts = academicChartData.counts;
        const statusOrderKeys = ["Xuất sắc", "Giỏi", "Khá", "Trung bình", "Yếu", "Kém"];
        const statusColors = { "Xuất sắc": '#28a745', "Giỏi": '#007bff', "Khá": '#ffc107', "Trung bình": '#17a2b8', "Yếu": '#fd7e14', "Kém": '#dc3545' };
        const labels = [], dataValues = [], backgroundColors = [];
        statusOrderKeys.forEach(key => {
            if (chartCounts[key] > 0) {
                labels.push(rankingLabels[key] || key);
                dataValues.push(chartCounts[key]);
                backgroundColors.push(statusColors[key]);
            }
        });
        if (dataValues.length > 0) {
            new Chart(document.getElementById('academicPieChart'), {
                type: 'doughnut', data: { labels: labels, datasets: [{ label: chartMessages.label, data: dataValues, backgroundColor: backgroundColors, hoverOffset: 10, borderColor: '#ffffff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed} ${chartMessages.studentUnit} (${(c.parsed/c.dataset.data.reduce((a,b)=>a+b,0)*100).toFixed(1)}%)` } } } }
            });
        }
    }

    function drawMajorChart() {
        if (!majorChartData || !majorChartData.majorCounts || Object.keys(majorChartData.majorCounts).length === 0) return;
        const labels = Object.keys(majorChartData.majorCounts);
        const dataValues = Object.values(majorChartData.majorCounts);
        const backgroundColors = labels.map((_, i) => ['#0d6efd', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'][i % 6]);
        if (dataValues.length > 0) {
            new Chart(document.getElementById('majorBarChart'), {
                type: 'bar', data: { labels: labels, datasets: [{ label: chartMessages.label, data: dataValues, backgroundColor: backgroundColors, borderWidth: 1.5, borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: chartMessages.label }, ticks: { callback: v => (v%1===0)?v:null } } } }
            });
        }
    }

    drawAcademicChart();
    drawMajorChart();
    /*]]>*/
</script>
</body>
</html>

