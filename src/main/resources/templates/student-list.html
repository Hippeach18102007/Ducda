<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{page.title.studentList}">Danh s√°ch Sinh vi√™n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* CSS cho badge tr·∫°ng th√°i l·ªõp */
        .badge-arranging {
            background-color: #ffc107; /* M√†u v√†ng */
            color: #212529; /* M√†u ch·ªØ ƒëen */
        }
        .carousel-control-prev, .carousel-control-next {
            width: 8%; /* TƒÉng khu v·ª±c b·∫•m m·ªôt ch√∫t */
        }
        .carousel-control-prev-icon, .carousel-control-next-icon {
            background-color: #343a40; /* M√†u t·ªëi cho icon */
            border-radius: 50%;
            padding: 1.5rem;
            opacity: 0.8;
        }
        .carousel-control-prev:hover .carousel-control-prev-icon,
        .carousel-control-next:hover .carousel-control-next-icon {
            opacity: 1;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary" th:text="#{header.studentList}">Danh s√°ch Sinh vi√™n</h1>

        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" th:title="#{lang.switch.tooltip}">
                <i class="fas fa-globe"></i> <span th:text="#{general.language?:'Ng√¥n ng·ªØ'}">Ng√¥n ng·ªØ</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item" th:href="@{/students/list(lang='vi')}">
                        <span th:text="#{lang.vietnamese}">Ti·∫øng Vi·ªát</span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" th:href="@{/students/list(lang='en')}">
                        <span th:text="#{lang.english}">English</span>
                    </a>
                </li>
            </ul>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </div>

    <div th:if="${message}" class="alert alert-success" role="alert"><span th:text="${message}"></span></div>

    <div class="mb-3 d-flex gap-2">
        <a th:href="@{/students/add}" class="btn btn-success"><span th:text="#{student.button.add}">‚ûï Th√™m Sinh vi√™n</span></a>
        <a th:href="@{/classes/add}" class="btn btn-info"><span th:text="#{button.addClass}">üè´ Th√™m L·ªõp h·ªçc</span></a>
        <a th:href="@{/diems/add}" class="btn btn-warning"><span th:text="#{button.addScore}">üíØ Th√™m ƒêi·ªÉm</span></a>
        <a th:href="@{/students/export-excel}" class="btn btn-secondary">
            <i class="fas fa-file-excel"></i> <span th:text="#{button.exportExcel}">Xu·∫•t B√°o c√°o Excel</span>
        </a>
    </div>

    <hr/>

    <h2 class="mt-5 mb-3 text-primary" th:text="#{header.chart}">Bi·ªÉu ƒë·ªì Th·ªëng k√™ Sinh vi√™n</h2>
    <div class="row mb-5">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-lg"> <div class="card-body">
                <div id="chartCarousel" class="carousel slide">

                    <div class="carousel-inner">

                        <div class="carousel-item active">
                            <div class="text-center bg-primary text-white p-2 mb-4 rounded">
                                <h4 class="mb-0" th:text="#{chart.cardHeader}">T·ª∑ l·ªá Sinh vi√™n theo X·∫øp lo·∫°i (D·ª±a tr√™n GPA)</h4>
                            </div>
                            <p class="text-center text-muted">
                                <span th:text="#{chart.totalStudentsLabel}">T·ªïng s·ªë SV ƒë∆∞·ª£c ƒë√°nh gi√° (ƒë√£ c√≥ ƒëi·ªÉm):</span>
                                <strong th:text="${academicChartData != null ? academicChartData.get('totalStudentsChecked') : 0}">0</strong>
                            </p>
                            <canvas id="academicPieChart" style="max-height: 400px;"></canvas>
                            <p th:if="${academicChartData == null or academicChartData.get('totalStudentsChecked') == 0}" class="text-center text-danger mt-3" th:text="#{chart.noData}">
                                Ch∆∞a c√≥ sinh vi√™n n√†o ƒë∆∞·ª£c th√™m ƒëi·ªÉm ƒë·ªÉ ƒë√°nh gi√°.
                            </p>
                        </div>

                        <div class="carousel-item">
                            <div class="text-center bg-secondary text-white p-2 mb-4 rounded">
                                <h4 class="mb-0">Ph√¢n b·ªï Sinh vi√™n theo Chuy√™n ng√†nh</h4>
                            </div>
                            <p class="text-center text-muted">
                                <span th:text="|#{chart.totalStudentsLabel} (T·ªïng SV):|">T·ªïng s·ªë Sinh vi√™n:</span>
                                <strong th:text="${majorChartData != null ? majorChartData.get('totalStudents') : 0}">0</strong>
                            </p>
                            <canvas id="majorBarChart" style="max-height: 400px;"></canvas>
                            <p th:if="${majorChartData == null or majorChartData.get('totalStudents') == 0}" class="text-center text-danger mt-3">
                                Ch∆∞a c√≥ sinh vi√™n n√†o trong h·ªá th·ªëng.
                            </p>
                        </div>

                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#chartCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#chartCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>

                </div>
            </div>
            </div>
        </div>
    </div>
    <hr/>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th th:text="#{table.header.id}">ID</th>
            <th th:text="#{table.header.studentName}">T√™n Sinh vi√™n</th>
            <th th:text="#{table.header.email}">Email</th>
            <th th:text="#{table.header.phone}">SƒêT</th>
            <th th:text="#{table.header.major}">Chuy√™n ng√†nh</th>
            <th th:text="#{table.header.class}">L·ªõp h·ªçc</th>
            <th th:text="#{table.header.course}">Kh√≥a h·ªçc</th>
            <th th:text="#{table.header.classStatus}">Tr·∫°ng th√°i l·ªõp</th>
            <th th:text="#{table.header.enrollment}">S·ªë SV/Ch·ªâ ti√™u</th>
            <th th:text="#{table.header.totalScores}">T·ªïng s·ªë m√¥n ƒëi·ªÉm</th>
            <th th:text="#{table.header.actions}">H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="student : ${students}">
            <td th:text="${student.studentId}"></td>
            <td th:text="${student.studentName}"></td>
            <td th:text="${student.email}"></td>
            <td th:text="${student.sdt}"></td>
            <td th:text="${student.chuyenNganh}"></td>

            <td colspan="4" th:if="${student.classInfo == null}">
                <span class="badge badge-arranging text-dark p-2" th:text="#{status.arrangingClass}">
                    ‚è≥ H·ªá th·ªëng ƒëang s·∫Øp x·∫øp l·ªõp h·ªçc cho b·∫°n
                </span>
            </td>

            <td th:unless="${student.classInfo == null}">
                <span th:text="${student.classInfo.className}"></span>
            </td>
            <td th:unless="${student.classInfo == null}" th:text="${student.classInfo.khoaHoc}"></td>
            <td th:unless="${student.classInfo == null}" th:text="${student.classInfo.trangThai}"></td>
            <td th:unless="${student.classInfo == null}" th:text="|${student.classInfo.soLuongSinhVienHienTai} / ${student.classInfo.soLuongSinhVien}|"></td>

            <td th:text="${student.scores != null ? student.scores.size() : 0}"></td>

            <td>
                <a th:href="@{/students/detail/{id}(id=${student.studentId})}" class="btn btn-sm btn-info" th:text="#{button.viewDetails}">
                    Xem chi ti·∫øt
                </a>
                <a th:href="@{/students/delete/{id}(id=${student.studentId})}"
                   class="btn btn-sm btn-danger"
                   th:onclick="|return confirm('[[#{confirm.deleteStudent}]]');|"
                   th:text="#{button.delete}">
                    X√≥a
                </a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // D·ªØ li·ªáu t·ª´ Controller
    const academicChartData = /*[[${academicChartData}]]*/ null;
    const majorChartData = /*[[${majorChartData}]]*/ null;

    // L·∫•y c√°c message keys c·∫ßn thi·∫øt cho Chart.js
    const chartMessages = {
        label: /*[[#{chart.tooltip.label}]]*/ 'S·ªë l∆∞·ª£ng Sinh vi√™n',
        studentUnit: /*[[#{chart.tooltip.studentUnit}]]*/ 'SV'
    };

    // ƒê·ªãnh nghƒ©a nh√£n x·∫øp lo·∫°i
    const rankingLabels = {
        "Xu·∫•t s·∫Øc": /*[[#{ranking.excellent}]]*/ 'Xu·∫•t s·∫Øc',
        "Gi·ªèi": /*[[#{ranking.good}]]*/ 'Gi·ªèi',
        "Kh√°": /*[[#{ranking.fair}]]*/ 'Kh√°',
        "Trung b√¨nh": /*[[#{ranking.average}]]*/ 'Trung b√¨nh',
        "Y·∫øu": /*[[#{ranking.weak}]]*/ 'Y·∫øu',
        "K√©m": /*[[#{ranking.poor}]]*/ 'K√©m'
    };

    // --- LOGIC V·∫º BI·ªÇU ƒê·ªí 1: H·ªåC L·ª∞C (PIE) ---
    function drawAcademicChart() {
        if (!academicChartData || (academicChartData.counts && Object.keys(academicChartData.counts).length === 0)) return;

        const chartCounts = academicChartData.counts || {};
        const statusOrderKeys = ["Xu·∫•t s·∫Øc", "Gi·ªèi", "Kh√°", "Trung b√¨nh", "Y·∫øu", "K√©m"];
        const statusColors = {
            "Xu·∫•t s·∫Øc": '#28a745', // Xanh l√°
            "Gi·ªèi": '#007bff',    // Xanh d∆∞∆°ng
            "Kh√°": '#ffc107',     // V√†ng
            "Trung b√¨nh": '#17a2b8', // Xanh nh·∫°t
            "Y·∫øu": '#fd7e14',     // Cam
            "K√©m": '#dc3545'      // ƒê·ªè
        };

        const labels = [];
        const dataValues = [];
        const backgroundColors = [];

        statusOrderKeys.forEach(statusKey => {
            const count = chartCounts[statusKey] || 0;
            if (count > 0) {
                labels.push(rankingLabels[statusKey] || statusKey);
                dataValues.push(count);
                backgroundColors.push(statusColors[statusKey]);
            }
        });

        if (dataValues.length > 0) {
            const ctx = document.getElementById('academicPieChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut', // THAY ƒê·ªîI: S·ª≠ d·ª•ng Doughnut Chart cho giao di·ªán ƒë·∫πp h∆°n
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartMessages.label,
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10, // TƒÉng hi·ªáu ·ª©ng hover
                        borderColor: '#ffffff', // Vi·ªÅn tr·∫Øng
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1) + '%'; // 1 ch·ªØ s·ªë th·∫≠p ph√¢n
                                    return `${label}: ${value} ${chartMessages.studentUnit} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    // --- LOGIC V·∫º BI·ªÇU ƒê·ªí 2: CHUY√äN NG√ÄNH (BAR) ---
    function drawMajorChart() {
        if (!majorChartData || (majorChartData.majorCounts && Object.keys(majorChartData.majorCounts).length === 0)) return;

        const majorCounts = majorChartData.majorCounts || {};
        const labels = Object.keys(majorCounts);
        const dataValues = Object.values(majorCounts);

        // T·∫°o m√†u s·∫Øc ng·∫´u nhi√™n/nh·∫•t qu√°n cho c√°c c·ªôt
        const backgroundColors = labels.map((_, index) => {
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'];
            return colors[index % colors.length];
        });

        if (dataValues.length > 0) {
            const ctx = document.getElementById('majorBarChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng Sinh vi√™n',
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('ff', 'aa')), // M√†u vi·ªÅn ƒë·∫≠m h∆°n
                        borderWidth: 1.5,
                        borderRadius: 5 // Bo g√≥c cho c·ªôt
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false } // ·∫®n legend cho Bar Chart
                    },
                    scales: {
                        x: {
                            grid: { display: false } // ·∫®n l∆∞·ªõi tr·ª•c X
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'S·ªë l∆∞·ª£ng Sinh vi√™n'
                            },
                            ticks: {
                                // ƒê·∫£m b·∫£o s·ªë l∆∞·ª£ng lu√¥n l√† s·ªë nguy√™n
                                callback: function(value) { if (value % 1 === 0) { return value; } }
                            }
                        }
                    }
                }
            });
        }
    }

    // --- G·ªåI H√ÄM V·∫º BI·ªÇU ƒê·ªí KHI T·∫¢I TRANG ---
    drawAcademicChart();
    drawMajorChart();

    /*]]>*/
</script>
</body>
</html>