<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{page.title.studentList}">Dashboard - Quản lý Sinh viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important; }
        .table-hover tbody tr:hover { background-color: #e9ecef; cursor: pointer; }
        .badge-arranging { background-color: #ffc107; color: #212529; }
        .carousel-control-prev-icon, .carousel-control-next-icon { background-color: rgba(0, 0, 0, 0.5); border-radius: 50%; padding: 1.5rem; }
        .table th, .table td { vertical-align: middle; }
        .action-buttons a { margin: 0 4px; }
        #chatToggleButton {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            z-index: 1050;
            font-size: 1.5rem;
        }

        #chatWindow {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 380px;
            max-width: 90vw;
            height: 500px;
            max-height: 70vh;
            z-index: 1049;
            display: none; /* Ẩn ban đầu */
            flex-direction: column;
            border-radius: 15px;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
        }

        #chatWindow.show {
            display: flex;
            transform: translateY(0);
            opacity: 1;
        }

        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            display: flex;
            max-width: 85%;
        }

        .chat-message .message-content {
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }

        .ai-message {
            align-self: flex-start;
        }
        .ai-message .message-content {
            background-color: #e9ecef;
            color: #212529;
            border-top-left-radius: 5px;
        }

        .user-message {
            align-self: flex-end;
        }
        .user-message .message-content {
            background-color: #0d6efd;
            color: white;
            border-top-right-radius: 5px;
        }
        .typing-indicator {
            align-self: flex-start;
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>
<input type="hidden" id="currentStudentId" th:value="${students.isEmpty() ? 0 : students[0].studentId}" />

<div class="container mt-4 mb-5">
    <div class="card shadow-sm mb-4">
        <div class="card-body p-4 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0 text-primary" th:text="#{header.studentList}">Student Management Dashboard</h1>
                <p class="text-muted mb-0" th:text="#{header.studentList.subtitle}">Tổng quan và quản lý sinh viên</p>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" th:title="#{lang.switch.tooltip}">
                    <i class="fas fa-globe"></i> <span th:text="#{general.language?:'Ngôn ngữ'}"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" th:href="@{/students/list(lang='vi')}" th:text="#{lang.vietnamese}"></a></li>
                    <li><a class="dropdown-item" th:href="@{/students/list(lang='en')}" th:text="#{lang.english}"></a></li>
                </ul>
            </div>
        </div>
    </div>

    <div th:if="${message}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <i class="fas fa-check-circle me-2"></i> <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i> <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2">
                <a th:href="@{/students/add}" class="btn btn-success"><i class="fas fa-user-plus me-2"></i><span th:text="#{student.button.add}"></span></a>
                <a th:href="@{/classes/list}" class="btn btn-info"><i class="fas fa-school me-2"></i><span th:text="#{button.addClass}"></span></a>
                <a th:href="@{/diems/add}" class="btn btn-warning"><i class="fas fa-graduation-cap me-2"></i><span th:text="#{button.addScore}"></span></a>
                <a th:href="@{/warnings/list}" class="btn btn-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i><span th:text="#{button.academicWarning}"></span>
                </a>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importExcelModal">
                    <i class="fas fa-file-import me-2"></i><span th:text="#{button.importExcel}"></span>
                </button>
                <a th:href="@{/students/export-excel}" class="btn btn-dark ms-auto">
                    <i class="fas fa-file-excel me-2"></i><span th:text="#{button.exportExcel}"></span>
                </a>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0 text-primary"><i class="fas fa-chart-pie me-2"></i><span th:text="#{header.chart}"></span></h4>
        </div>
        <div class="card-body">
            <div id="chartCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="text-center bg-primary-subtle text-primary-emphasis p-2 mb-3 rounded">
                            <h5 class="mb-0" th:text="#{chart.cardHeader}"></h5>
                        </div>
                        <p class="text-center text-muted"><span th:text="#{chart.totalStudentsLabel}"></span>: <strong th:text="${academicChartData?.get('totalStudentsChecked') ?: 0}"></strong></p>
                        <canvas id="academicPieChart" style="max-height: 350px;"></canvas>
                        <p th:if="${academicChartData == null or academicChartData.get('totalStudentsChecked') == 0}" class="text-center text-danger mt-3" th:text="#{chart.noData}"></p>
                    </div>
                    <div class="carousel-item">
                        <div class="text-center bg-secondary-subtle text-secondary-emphasis p-2 mb-3 rounded">
                            <h5 class="mb-0">Phân bổ Sinh viên theo Chuyên ngành</h5>
                        </div>
                        <p class="text-center text-muted"><span th:text="|#{chart.totalStudentsLabel} (Tổng SV):|"></span>: <strong th:text="${majorChartData?.get('totalStudents') ?: 0}"></strong></p>
                        <canvas id="majorBarChart" style="max-height: 350px;"></canvas>
                        <p th:if="${majorChartData == null or majorChartData.get('totalStudents') == 0}" class="text-center text-danger mt-3"></p>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#chartCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span></button>
                <button class="carousel-control-next" type="button" data-bs-target="#chartCarousel" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span></button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-light p-3">
            <h4 class="mb-0 text-primary"><i class="fas fa-list-ul me-2"></i><span th:text="#{table.title.detailedList}"></span></h4>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th th:text="#{table.header.id}"></th>
                        <th th:text="#{table.header.studentName}"></th>
                        <th th:text="#{table.header.email}"></th>
                        <th th:text="#{table.header.major}"></th>
                        <th th:text="#{table.header.class}"></th>
                        <th th:text="#{table.header.enrollment}"></th>
                        <th class="text-center" th:text="#{table.header.totalScores}"></th>
                        <th class="text-center" th:text="#{table.header.actions}"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="student : ${students}">
                        <td th:text="${student.studentId}"></td>
                        <td>
                            <div class="fw-bold" th:text="${student.studentName}"></div>
                            <div class="small text-muted" th:text="${student.sdt}"></div>
                        </td>
                        <td th:text="${student.email}"></td>
                        <td th:text="${student.chuyenNganh}"></td>

                        <td colspan="2" th:if="${student.classInfo == null}">
                            <span class="badge badge-arranging text-dark p-2" th:text="#{status.arrangingClass}"></span>
                        </td>

                        <td th:unless="${student.classInfo == null}">
                            <span class="fw-bold" th:text="${student.classInfo.className}"></span>
                            <div class="small text-muted" th:text="${student.classInfo.khoaHoc}"></div>
                        </td>
                        <td th:unless="${student.classInfo == null}" th:text="|${student.classInfo.soLuongSinhVienHienTai} / ${student.classInfo.soLuongSinhVien}|"></td>

                        <td class="text-center"><span class="badge bg-primary rounded-pill" th:text="${student.scores != null ? student.scores.size() : 0}"></span></td>

                        <td class="text-center action-buttons">
                            <a th:href="@{/students/detail/{id}(id=${student.studentId})}" class="btn btn-sm btn-outline-primary" th:title="#{button.viewDetails}"><i class="fas fa-eye"></i></a>
                            <a th:href="@{/students/delete/{id}(id=${student.studentId})}" class="btn btn-sm btn-outline-danger" th:onclick="|return confirm('[[#{confirm.deleteStudent}]]');|" th:title="#{button.delete}"><i class="fas fa-trash-alt"></i></a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importExcelModal" tabindex="-1" aria-labelledby="importExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importExcelModalLabel"><i class="fas fa-file-excel text-success me-2"></i> Nhập Sinh viên từ File Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/students/upload-excel}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-3">
                        <label for="file" class="form-label">Chọn file Excel:</label>
                        <input type="file" class="form-control" name="file" id="file" accept=".xlsx, .xls" required>
                    </div>
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Định dạng file yêu cầu:</h6>
                        <ul class="mb-0 small">
                            <li>File phải là `.xlsx` hoặc `.xls`.</li>
                            <li>Dòng đầu tiên là tiêu đề (sẽ được bỏ qua).</li>
                            <li>Dữ liệu sinh viên bắt đầu từ dòng thứ 2.</li>
                            <li>Thứ tự các cột: <strong>Tên SV, Email, SĐT, Chuyên ngành</strong>.</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="submit" class="btn btn-success" form="uploadForm"><i class="fas fa-upload me-2"></i> Tải lên</button>
            </div>
        </div>
    </div>
</div>

<button class="btn btn-primary rounded-circle shadow-lg" id="chatToggleButton" title="Trợ lý AI">
    <i class="fas fa-comment-dots fa-lg"></i>
</button>

<div class="card shadow-lg" id="chatWindow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Trợ lý AI Giáo dục</h5>
        <button type="button" class="btn-close btn-close-white" id="closeChatButton" aria-label="Close"></button>
    </div>
    <div class="card-body" id="chatMessages">
        <div class="chat-message ai-message">
            <div class="message-content">
                Xin chào! Tôi có thể giúp gì cho bạn về vấn đề học tập?
            </div>
        </div>
    </div>
    <div class="card-footer">
        <form id="chatForm">
            <div class="input-group">
                <input type="text" id="chatInput" class="form-control" placeholder="Nhập câu hỏi của bạn..." autocomplete="off">
                <button class="btn btn-primary" type="submit" id="sendChatButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // JAVASCRIPT FOR CHARTS (Giữ nguyên, không thay đổi)
    const academicChartData = /*[[${academicChartData}]]*/ null;
    const majorChartData = /*[[${majorChartData}]]*/ null;
    const chartMessages = { label: /*[[#{chart.tooltip.label}]]*/ 'Số lượng Sinh viên', studentUnit: /*[[#{chart.tooltip.studentUnit}]]*/ 'SV' };
    const rankingLabels = { "Xuất sắc": /*[[#{ranking.excellent}]]*/ 'Xuất sắc', "Giỏi": /*[[#{ranking.good}]]*/ 'Giỏi', "Khá": /*[[#{ranking.fair}]]*/ 'Khá', "Trung bình": /*[[#{ranking.average}]]*/ 'Trung bình', "Yếu": /*[[#{ranking.weak}]]*/ 'Yếu', "Kém": /*[[#{ranking.poor}]]*/ 'Kém' };
    function drawAcademicChart() { if (!academicChartData || !academicChartData.counts || Object.keys(academicChartData.counts).length === 0) return; const chartCounts = academicChartData.counts; const statusOrderKeys = ["Xuất sắc", "Giỏi", "Khá", "Trung bình", "Yếu", "Kém"]; const statusColors = { "Xuất sắc": '#28a745', "Giỏi": '#007bff', "Khá": '#ffc107', "Trung bình": '#17a2b8', "Yếu": '#fd7e14', "Kém": '#dc3545' }; const labels = [], dataValues = [], backgroundColors = []; statusOrderKeys.forEach(key => { if (chartCounts[key] > 0) { labels.push(rankingLabels[key] || key); dataValues.push(chartCounts[key]); backgroundColors.push(statusColors[key]); } }); if (dataValues.length > 0) { new Chart(document.getElementById('academicPieChart'), { type: 'doughnut', data: { labels: labels, datasets: [{ label: chartMessages.label, data: dataValues, backgroundColor: backgroundColors, hoverOffset: 10, borderColor: '#ffffff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed} ${chartMessages.studentUnit} (${(c.parsed/c.dataset.data.reduce((a,b)=>a+b,0)*100).toFixed(1)}%)` } } } } }); } }
    function drawMajorChart() { if (!majorChartData || !majorChartData.majorCounts || Object.keys(majorChartData.majorCounts).length === 0) return; const labels = Object.keys(majorChartData.majorCounts); const dataValues = Object.values(majorChartData.majorCounts); const backgroundColors = labels.map((_, i) => ['#0d6efd', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'][i % 6]); if (dataValues.length > 0) { new Chart(document.getElementById('majorBarChart'), { type: 'bar', data: { labels: labels, datasets: [{ label: chartMessages.label, data: dataValues, backgroundColor: backgroundColors, borderWidth: 1.5, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: chartMessages.label }, ticks: { callback: v => (v%1===0)?v:null } } } } }); } }
    drawAcademicChart();
    drawMajorChart();

    // JAVASCRIPT FOR CHATBOT (Phần này đã được cập nhật)
    document.addEventListener('DOMContentLoaded', function () {
        const chatToggleButton = document.getElementById('chatToggleButton');
        const chatWindow = document.getElementById('chatWindow');
        const closeChatButton = document.getElementById('closeChatButton');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');

        // Mở/đóng cửa sổ chat
        chatToggleButton.addEventListener('click', () => chatWindow.classList.toggle('show'));
        closeChatButton.addEventListener('click', () => chatWindow.classList.remove('show'));

        // Gửi tin nhắn khi submit form
        chatForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const userMessage = chatInput.value.trim();

            // **THAY ĐỔI 2**: Lấy studentId từ thẻ input ẩn
            const studentId = document.getElementById('currentStudentId').value;

            if (userMessage === '') return;

            appendMessage(userMessage, 'user');
            chatInput.value = '';
            const typingIndicator = showTypingIndicator();

            try {
                // **THAY ĐỔI 3**: Gọi API tới backend với body mới
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: userMessage,
                        studentId: parseInt(studentId) // Gửi kèm studentId
                    })
                });

                if (!response.ok) { throw new Error('Network response was not ok.'); }

                const data = await response.json();
                const aiReply = data.reply;

                typingIndicator.remove();
                // **THAY ĐỔI 5**: Gọi hàm appendMessage với cờ isHtml = true
                appendMessage(aiReply, 'ai', true);

            } catch (error) {
                console.error('Error fetching chat response:', error);
                typingIndicator.remove();
                appendMessage('Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại sau.', 'ai');
            }
        });

        // **THAY ĐỔI 4**: Cập nhật hàm appendMessage để xử lý HTML
        function appendMessage(message, sender, isHtml = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-message', sender + '-message');

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');

            if (isHtml) {
                // Dùng innerHTML để render các thẻ như <br>, <b>... từ AI
                // Chuyển đổi ký tự xuống dòng thành thẻ <br>
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            } else {
                messageContent.textContent = message;
            }

            messageWrapper.appendChild(messageContent);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hàm hiển thị chỉ báo đang gõ
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.classList.add('chat-message', 'ai-message', 'typing-indicator');
            const content = document.createElement('div');
            content.classList.add('message-content');
            content.innerHTML = '<i>Trợ lý đang soạn câu trả lời...</i>';
            indicator.appendChild(content);
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return indicator;
        }
    });
    /*]]>*/
</script>
</body>
</html>