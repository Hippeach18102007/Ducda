<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thêm Điểm Mới</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .form-label { font-weight: 600; }
  </style>
</head>
<body>
<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark text-center py-3">
          <h2 class="mb-0"><i class="fas fa-plus-circle me-2"></i> Thêm Điểm Mới</h2>
        </div>
        <div class="card-body p-4">
          <form th:action="@{/diems/add}" th:object="${diemManager}" method="post">

            <div class="mb-3">
              <label for="majorFilter" class="form-label"><i class="fas fa-filter text-warning me-2"></i>Lọc theo Chuyên ngành:</label>
              <select class="form-select" id="majorFilter">
                <option value="">-- Tất cả Chuyên ngành --</option>
                <option th:each="major : ${majors}" th:value="${major}" th:text="${major}"></option>
              </select>
            </div>

            <div class="mb-3">
              <label for="classFilter" class="form-label"><i class="fas fa-filter text-warning me-2"></i>Lọc theo Lớp học:</label>
              <select class="form-select" id="classFilter">
                <option value="">-- Tất cả Lớp học --</option>
                <option th:each="class : ${classes}"
                        th:value="${class.idClass}"
                        th:data-major="${class.khoaHoc}"
                        th:text="${class.className} + ' (' + ${class.khoaHoc} + ')'">
                </option>
              </select>
            </div>

            <hr class="my-4">

            <div class="mb-4">
              <label for="id" class="form-label"><i class="fas fa-user-graduate text-warning me-2"></i>Sinh viên:</label>
              <select class="form-select" id="id" th:field="*{id}" required>
                <option value="">-- Chọn Sinh viên --</option>
                <option th:each="student : ${allStudents}"
                        th:value="${student.id}"
                        th:data-class-id="${student.idClass}"
                        th:data-major="${student.chuyenNganh}"
                        th:text="${student.studentName} + ' (ID: ' + ${student.id} + ' | ' + ${student.chuyenNganh} + ')'">
                </option>
              </select>
            </div>

            <div class="mb-4">
              <label for="monhoc" class="form-label"><i class="fas fa-book-open text-warning me-2"></i>Môn học:</label>
              <input type="text" class="form-control" id="monhoc" th:field="*{monhoc}" placeholder="Tên môn học" required>
            </div>

            <div class="mb-4">
              <label for="diem" class="form-label"><i class="fas fa-clipboard-check text-warning me-2"></i>Điểm số:</label>
              <input type="number" step="0.1" min="0" max="10" class="form-control" id="diem" th:field="*{diem}" placeholder="Nhập điểm (0.0 - 10.0)" required>
            </div>

            <div class="d-flex justify-content-start gap-2 mt-4 pt-3 border-top">
              <button type="submit" class="btn btn-warning btn-lg">
                <i class="fas fa-save me-2"></i> Lưu Điểm
              </button>
              <a th:href="@{/students/list}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i> Hủy bỏ
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const majorFilter = document.getElementById('majorFilter');
    const classFilter = document.getElementById('classFilter');
    const studentSelect = document.getElementById('id');

    const allClassOptions = Array.from(classFilter.options);
    const allStudentOptions = Array.from(studentSelect.options);

    function filterOptions(selectElement, allOptions, filterFn) {
      selectElement.innerHTML = '';
      allOptions.forEach(option => {
        if (filterFn(option)) {
          selectElement.add(option.cloneNode(true));
        }
      });
      selectElement.value = ""; // Reset selection
    }

    // Lọc Lớp học khi Chuyên ngành thay đổi
    function updateClassFilter() {
      const selectedMajor = majorFilter.value;
      filterOptions(classFilter, allClassOptions, (option) => {
        return option.value === "" || !selectedMajor || option.dataset.major === selectedMajor;
      });
      updateStudentFilter();
    }

    // Lọc Sinh viên khi Lớp hoặc Chuyên ngành thay đổi
    function updateStudentFilter() {
      const selectedMajor = majorFilter.value;
      const selectedClassId = classFilter.value;

      filterOptions(studentSelect, allStudentOptions, (option) => {
        if (option.value === "") return true;

        const matchesMajor = !selectedMajor || option.dataset.major === selectedMajor;
        const matchesClass = !selectedClassId || option.dataset.classId === selectedClassId;

        return matchesMajor && matchesClass;
      });
    }

    // Gắn sự kiện
    majorFilter.addEventListener('change', updateClassFilter);
    classFilter.addEventListener('change', updateStudentFilter);
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>